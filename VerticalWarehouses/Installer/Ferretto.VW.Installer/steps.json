{
  "steps": [
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 1,
      "title": "Imposta chiavi di registro",
      "description": "Cambia, aggiunge chiavi di registro per configurazione iniziale.",
      "script": "Rename-NetAdapter -Name \"$(PPC:Ethernet:Machine:FactoryAlias)\" -NewName \"Ethernet-Machine\";Set-ItemProperty HKCU:\\Software\\Microsoft\\Wisp\\Touch -Name TouchMode_hold  -Value '0';uwfmgr.exe registry add-exclusion HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run;uwfmgr.exe registry add-exclusion HKLM\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Schedule;schtasks.exe /Create /SC ONLOGON /TN \"$(Install:TaskScheduler:Installer)\" /TR \"$(Update:Temp:Path)\\$(Install:Installer:Path)\\$(Install:Installer:FilePath)\" /RL HIGHEST /F",
      "setupMode": "install",
      "skipOnResume": "true"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 2,
      "title": "Creazione cartelle database",
      "description": "Creazione cartelle 'Database' su dischi E,F",
      "script": "New-Item -ItemType Directory -Path E:\\Database;New-Item -ItemType Directory -Path F:\\Database",
      //"script": "timeout /T 2", // ** fake
      "setupMode": "install",
      "skipOnResume": "true"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 3,
      "title": "Imposta indirizzo ip su scheda ethernet 'Ethernet-Machine'",
      "description": "Imposta indirizzo ip e subnet su scheda ethernet che si interfaccia con la macchina.",
      //"script": "New-NetIPAddress -InterfaceAlias \"Ethernet-Machine\" -AddressFamily IPv4 $(Install:Parameter:PpcIpaddress) -PrefixLength 24 -Type Unicast",
      "script": "timeout /T 2", // ** fake
      "setupMode": "install",
      "skipOnResume": "true"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 4,
      "title": "Installazione servizio automazione",
      "description": "Crea il servizio di automazione da avviare con l'accensione del PanelPc",
      "script": "New-Service -name $(MAS:ServiceName) -binaryPathName \"$(Install:Root:Path)\\$(Install:MAS:Path)\\$(Install:MAS:FilePath) --service\" -displayName \"$(MAS:Service:DisplayName)\" -description \"$(MAS:Service:Description)\" -startupType Automatic",
      "rollbackScript": "sc.exe delete $(MAS:ServiceName)",
      //"script": "timeout /T 2", // ** fake
      "setupMode": "install",
      "skipOnResume": "true"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 5,
      "title": "Disabilita UWF",
      "description": "Disabilita la protezione del disco fisso (Unified Write Filter) per permettere l'aggiornamento.",
      "script": "uwfmgr filter disable",
      "rollbackScript": "uwfmgr filter enable",
      "setupMode": "update"
      //"script": "timeout /T 2", // ** fake
      //"rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 6,
      "title": "Auto-avvio installer",
      "description": "Imposta l'installatore in avvio automatico.",
      //"rollbackScript": "Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath)\"",
      //"script": "Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(EmbeddedInstallationFilePath)\"",
      "script": "Remove-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key);schtasks.exe /Create /SC ONLOGON /TN \"$(Install:TaskScheduler:Installer)\" /TR \"$(Update:Temp:Path)\\$(Install:Installer:Path)\\$(Install:Installer:FilePath)\" /RL HIGHEST /F",
      "rollbackScript": "Set-ItemProperty $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath)\";schtasks.exe /Delete /TN \"$(Install:TaskScheduler:Installer)\" /F",
      "setupMode": "update",
      "skipOnResume": "true"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 7,
      "title": "Riavvia il sistema",
      "description": "Riavvia il sistema operativo per completare la disabilitazione della protezione.",
      //"script": "shutdown /r /t 0 /f /d p:4:2 /c \"Vertimag Software Setup\"",
      "script": "timeout /T 2", // ** fake
      "setupMode": "update",
      "skipOnResume": "true"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 8,
      "title": "Controlla stato UWF",
      "description": "Controlla che la protezione del disco fisso sia disabilitata.",
      //"script": "$NAMESPACE = \"root\\standardcimv2\\embedded\";$uwfInstance = Get-WmiObject -Namespace $NAMESPACE -Class UWF_Filter -List;if(!$uwfInstance){throw  \"UWF is NOT installed.\"};$uwfInstance = Get-WmiObject -Namespace $NAMESPACE -Class UWF_Filter;if(!$uwfInstance.CurrentEnabled){throw  \"UWF is currently NOT enabled.\"};",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "true",
      //"rollbackScript": "timeout /T 2" // ** fake
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 9,
      "title": "Ferma il MAS",
      "description": "Ferma il servizio di automazione, in modo da poterlo aggiornare.",
      "script": "Stop-Service \"$(MAS:ServiceName)\"",
      "rollbackScript": "Start-Service \"$(MAS:ServiceName)\"",
      "machineRole": "Master",
      "setupMode": "update"
      //"script": "timeout /T 2", // ** fake
      //rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 10,
      "title": "Backup applicazione",
      "description": "Sposta l'applicazione nella cartella di backup",
      "script": "$stageAs=\"$(Backup:Root:Path)\\Staging\\$(Install:MAS:Path)\";$stagePpc=\"$(Backup:Root:Path)\\Staging\\$(Install:PPC:Path)\";$as=\"$(Install:Root:Path)\\$(Install:MAS:Path)\";$ppc=\"$(Install:Root:Path)\\$(Install:PPC:Path)\";if(Test-Path $stageAs -PathType Container) {Remove-Item $stageAs -Recurse -Force};if(Test-Path $stagePpc -PathType Container) {Remove-Item $stagePpc -Recurse -Force};Copy-Item $as $stageAs -Recurse;Copy-Item $ppc $stagePpc -Recurse;Remove-Item $as -Force -Recurse;Remove-Item $ppc -Force -Recurse",
      "rollbackScript": "$stageAs=\"$(Backup:Root:Path)\\Staging\\$(Install:MAS:Path)\";$stagePpc=\"$(Backup:Root:Path)\\Staging\\$(Install:PPC:Path)\";$as=\"$(Install:Root:Path)\\$(Install:MAS:Path)\";$ppc=\"$(Install:Root:Path)\\$(Install:PPC:Path)\";Copy-Item $stageAs -Recurse  -Exclude (Get-ChildItem $as -Recurse);Copy-Item $stagePpc $ppc -Recurse -Exclude (Get-ChildItem $ppc -Recurse);Remove-Item $stageAs -Force -Recurse;Remove-Item $stagePpc -Force -Recurse",
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.DbBackupStep, Ferretto.VW.Installer.Core",
      "number": 11,
      "title": "Backup database",
      "description": "Fa una copia locale dei database del MAS, in preparazione per il backup",
      "automationServicePath": "$(Install:Root:Path)\\$(Install:MAS:Path)",
      "backupPath": "$(Backup:Root:Path)\\Staging",
      "machineRole": "master",
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 12,
      "title": "Creazione ZIP",
      "description": "Crea un archivio zip con il backup della versione corrente.",
      "script": "if(Test-Path $(Backup:Root:Path)\\Current_Version_Backup.zip -PathType Leaf){del $(Backup:Root:Path)\\Current_Version_Backup.zip}; Compress-Archive $(Backup:Root:Path)\\staging -DestinationPath $(Backup:Root:Path)\\Current_Version_Backup.zip -CompressionLevel Optimal",
      "rollbackScript": "if (Test-Path $(Backup:Root:Path)\\Current_Version_Backup.zip -PathType Leaf){Remove-Item $(Backup:Root:Path)\\Current_Version_Backup.zip}",
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 13,
      "title": "Copia nuova versione",
      "description": "Copia la nuova versione nella cartella di destinazione dell'installazione.",
      "script": "Copy-Item $(Update:Temp:Path)\\$(Install:MAS:Path) $(Install:Root:Path) -recurse; Copy-Item $(Update:Temp:Path)\\$(Install:PPC:Path) $(Install:Root:Path) -recurse",
      "rollbackScript": "Remove-Item $(Install:Root:Path)\\$(Install:MAS:Path) -recurse;Remove-Item $(Install:Root:Path)\\$(Install:PPC:Path) -recurse;"
    },
    /*{
      "$type": "Ferretto.VW.Installer.Core.MergeAppConfig, Ferretto.VW.Installer.Core",
      "number": 14,
      "title": "Configura App PanelPC",
      "description": "Aggiorna il file di configurazione del Panel PC.",
      "newPathName": "$(Install:Root:Path)\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config",
      "oldPathName": "$(Backup:Root:Path)\\Staging\\App\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 14,
      "title": "Copia file configurazione App PanelPC",
      "description": "Aggiorna il file di configurazione del Panel PC.",
      "script": "cp $(Backup:Root:Path)\\Staging\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config $(Install:Root:Path)\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config"
    },*/
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 14,
      "title": "Configura App PanelPC",
      "description": "Aggiorna il file di configurazione del Panel PC.",
      "script": "$NewAppConfigFile = \"$(Update:Temp:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath).config\";$CurrentAppConfigFile= \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath).config\";$NewAppConfigFileOrig = \"$($NewAppConfigFile).orig\";[xml]$NewAppConfigXml = Get-Content -Path $NewAppConfigFile;[xml]$CurrentAppConfigXml = Get-Content -Path $CurrentAppConfigFile;$NewAppConfigXml.Save($NewAppConfigFileOrig);Foreach ($Node in $NewAppConfigXml.configuration.appSettings.ChildNodes) { $currNode = $CurrentAppConfigXml.SelectSingleNode(\"//add[@key=\"\"$($node.key)\"\"]/@value\"); if ($currNode.Value) { $Node.value = $currNode.Value; } }; $CurrentAppConfigXml.Save($CurrentAppConfigFile)",
      "rollbackScript": "$NewAppConfigFile = \"$(Update:Temp:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath).config\";$NewAppConfigFileOrig = \"$($NewAppConfigFile).orig\";if (Test-Path $NewAppConfigFileOrig) { Rename-item –path $NewAppConfigFileOrig –newname $($NewAppConfigFile) -Force  };",
      "setupMode": "update"
      //"script": "timeout /T 2", // ** fake
      //"rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 15,
      "title": "Copia file configurazione MAS",
      "description": "Aggiorna il file di configurazione del MAS.",
      "script": "cp $(Backup:Root:Path)\\Staging\\$(Install:MAS:Path)\\appsettings.json $(Install:Root:Path)\\$(Install:MAS:Path)\\appsettings.json",
      "machineRole": "master"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 16,
      "title": "Aggiorna MAS",
      "description": "Aggiorna il file di configurazione del MAS.",
      "script": "function Join-Objects($source, $extend){ if($source.GetType().Name -eq \\\"PSCustomObject\\\" -and $extend.GetType().Name -eq \\\"PSCustomObject\\\"){ foreach($Property in $source | Get-Member -type NoteProperty, Property){ if($extend.$($Property.Name) -eq $null){ continue; } $source.$($Property.Name) = Join-Objects $source.$($Property.Name) $extend.$($Property.Name)  } } else{ $source = $extend;};if($source.GetType().Name -eq \\\"Object[]\\\" -and $source.Count -lt 2){ return ,$source} else {return $source } };function AddPropertyRecurse($source, $toExtend){  if($source.GetType().Name -eq \\\"PSCustomObject\\\") { foreach($Property in $source | Get-Member -type NoteProperty, Property){if($toExtend.$($Property.Name) -eq $null) { $toExtend | Add-Member -MemberType NoteProperty -Value $source.$($Property.Name) -Name $Property.Name  } else{ $toExtend.$($Property.Name) = AddPropertyRecurse $source.$($Property.Name) $toExtend.$($Property.Name) }}} return $toExtend};function Json-Merge($source, $extend){ $merged = Join-Objects $source $extend; return $merged;};$NewAppsettingsFile = \"$(Update:Temp:Path)\\$(Install:MAS:Path)\\appsettings.json\";$CurrAppsettingsFile = \"$(Install:Root:Path)\\$(Install:MAS:Path)\\appsettings.json\";$NewAppSettingFileCopy = \"$(Update:Temp:Path)\\$(Install:MAS:Path)\\appsettings.orig\";$1 = Get-Content -Raw -Path $NewAppSettingsFile | ConvertFrom-Json;$2 = Get-Content -Path $CurrAppsettingsFile| ConvertFrom-Json;$3 = Json-Merge $1 $2;Copy-Item -Path $NewAppsettingsFile -Destination $NewAppSettingFileCopy;$3 | ConvertTo-Json -depth 100 | Out-File $NewAppsettingsFile",
      "rollbackScript": "$NewAppsettingsFile = \"$(Update:Temp:Path)\\$(Install:MAS:Path)\\appsettings.json\";$NewAppsettingsFileOrig = \"$(Update:Temp:Path)\\$(Install:MAS:Path)\\appsettings.orig\";if (Test-Path $NewAppsettingsFileOrig) { Rename-item –path $NewAppsettingsFileOrig –newname $($NewAppsettingsFile) -Force  };",
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 17,
      "title": "Avvia il MAS",
      "description": "Avvia il servizio di automazione aggiornato così che il database venga aggiornato.",
      "script": "Start-Service \"$(MAS:ServiceName)\"",
      "rollbackScript": "Stop-Service \"$(MAS:ServiceName)\"",
      "machineRole": "master"
      //"script": "timeout /T 2", // ** fake
      //"rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.MasHealthCheckStep, Ferretto.VW.Installer.Core",
      "number": 18,
      "title": "Verifica stato del MAS",
      "description": "Verifica che il servizio di automazione dichiari di essere operativo.",
      "url": "$(MAS:BaseUrl)/health/live",
      "timeout": "10000",
      "machineRole": "master"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 19,
      "title": "Cancella backup precedente",
      "description": "Elimina, se esiste, l'archivio contenente il backup della versione precedente a quella installata prima dell'aggiornamento.",
      "script": "if(Test-Path $(Backup:Root:Path)\\Backup.zip -PathType Leaf) { Remove-Item $(Backup:Root:Path)\\Backup.zip -ErrorAction SilentlyContinue }",
      "skipRollback": true,
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 20,
      "title": "Rinomina backup corrente",
      "description": "Rinomina lo zip della versione corrente.",
      "script": "Rename-Item $(Backup:Root:Path)\\Current_Version_Backup.zip $(Backup:Root:Path)\\Backup.zip",
      "skipRollback": true,
      "setupMode": "update"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 21,
      "title": "Cancella file temporanei",
      "description": "Elimina i file temporanei creati durante la fase di aggiornamento.",
      "script": "Remove-Item $(Backup:Root:Path)\\Staging -Recurse",
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 22,
      "title": "Riabilita UWF",
      "description": "Riabilita la protezione del disco fisso per sigillare il PanelPC.",
      //"script": "uwfmgr filter enable",
      //"rollbackScript": "uwfmgr filter disable",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2", // ** fake
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 23,
      "title": "Riavvia il sistema",
      "description": "Riavvia il sistema operativo per completare l'abilitazione della protezione.",
      //"script": "shutdown /r /t 0 /f /d p:4:2 /c \"Vertimag Software Setup\"",
      "script": "timeout /T 2", // ** fake
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 24,
      "title": "Controlla stato UWF",
      "description": "Controlla che la protezione del disco fisso sia abilitata.",
      //"script": "$NAMESPACE = \"root\\standardcimv2\\embedded\";$uwfInstance = Get-WmiObject -Namespace $NAMESPACE -Class UWF_Filter -List;if(!$uwfInstance){throw  \"UWF is NOT installed.\"};$uwfInstance = Get-WmiObject -Namespace $NAMESPACE -Class UWF_Filter;if($uwfInstance.CurrentEnabled){throw  \"UWF is currently NOT disaabled.\"};",
      //"rollbackScript": "uwfmgr filter disable"
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 25,
      "title": "Auto Avvio PPC",
      "description": "Imposta l'applicazione del PanelPC in avvio automatico dopo il login.",
      //"script": "Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath)\"",
      //"rollbackScript": "\"Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(EmbeddedInstallationFilePath)\""
      "script": "Set-ItemProperty $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath)\";schtasks.exe /Delete /TN \"$(Install:TaskScheduler:Installer)\" /F",
      "rollbackScript": "Remove-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key);schtasks.exe /Create /SC ONLOGON /TN \"$(Install:TaskScheduler:Installer)\" /TR \"$(Update:Temp:Path)\\$(Install:Installer:Path)\\$(Install:Installer:FilePath)\" /RL HIGHEST /F"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 26,
      "title": "Riavvia il sistema",
      "description": "Riavvia il sistema operativo per l'auto avvio del software PanelPC.",
      //"script": "shutdown /r /t 0 /f /d p:4:2 /c \"Vertimag Software Setup\"",
      "script": "timeout /T 20000", // ** fake
      "skipRollback": true
    }
  ]
}
