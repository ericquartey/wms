{
  "steps": [
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 1,
      "title": "Disabilita UWF",
      "description": "Disabilita la protezione del disco fisso (Unified Write Filter) per permettere l'aggiornamento.",
      //"script": "uwfmgr filter disable",
      //"rollbackScript": "uwfmgr filter enable",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 2,
      "title": "Auto-avvio installer",
      "description": "Imposta l'installatore in avvio automatico.",
      "rollbackScript": "Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath)\"",
      "script": "Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(EmbeddedInstallationFilePath)\""
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 3,
      "title": "Riavvia il sistema",
      "description": "Riavvia il sistema operativo per completare la disabilitazione della protezione.",
      // "script": "shutdown /r /t 0 /f /d p:4:2 /c \"Vertimag Software Setup\"",
      "script": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 4,
      "title": "Controlla stato UWF",
      "description": "Controlla che la protezione del disco fisso sia disabilitata.",
      //"script": "uwfmgr filter disable",
      //"rollbackScript": "uwfmgr filter enable",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 5,
      "title": "Ferma il MAS",
      "description": "Ferma il servizio di automazione, in modo da poterlo aggiornare.",
      // "script": "Stop-Service \"$(MAS:ServiceName)\"",
      // "rollbackScript": "Start-Service \"$(MAS:ServiceName)\"",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.AppBackupStep, Ferretto.VW.Installer.Core",
      "number": 7,
      "title": "Backup applicazione",
      "description": "Sposta l'applicazione nella cartella di backup",
      "appRootPath": "$(Install:Root:Path)",
      "backupPath": "$(Backup:Root:Path)\\Staging"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.DbBackupStep, Ferretto.VW.Installer.Core",
      "number": 6,
      "title": "Backup database",
      "description": "Fa una copia locale dei database del MAS, in preparazione per il backup",
      "automationServicePath": "$(Install:Root:Path)\\$(Install:MAS:Path)",
      "backupPath": "$(Backup:Root:Path)\\Staging"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 8,
      "title": "Creazione ZIP",
      "description": "Crea un archivio zip con il backup della versione corrente.",
      "script": "if(Test-Path $(Backup:Root:Path)\\Current_Version_Backup.zip -PathType Leaf){del $(Backup:Root:Path)\\Current_Version_Backup.zip}; Compress-Archive $(Backup:Root:Path)\\staging -DestinationPath $(Backup:Root:Path)\\Current_Version_Backup.zip -CompressionLevel Optimal",
      "rollbackScript": "if (Test-Path $(Backup:Root:Path)\\Current_Version_Backup.zip -PathType Leaf){Remove-Item $(Backup:Root:Path)\\Current_Version_Backup.zip}"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 9,
      "title": "Copia nuova versione",
      "description": "Copia la nuova versione nella cartella di destinazione dell'installazione.",
      "script": "Copy-Item ..\\$(Install:MAS:Path)\\*.* $(Install:Root:Path)\\$(Install:MAS:Path); Copy-Item ..\\$(Install:PPC:Path)\\*.* $(Install:Root:Path)\\$(Install:PPC:Path)",
      "rollbackScript": "Remove-Item $(Install:Root:Path) -Recurse"
    },
    /*{
      "$type": "Ferretto.VW.Installer.Core.MergeAppConfig, Ferretto.VW.Installer.Core",
      "number": 10,
      "title": "Configura App PanelPC",
      "description": "Aggiorna il file di configurazione del Panel PC.",
      "newPathName": "$(Install:Root:Path)\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config",
      "oldPathName": "$(Backup:Root:Path)\\Staging\\App\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config"
    },*/
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 10,
      "title": "Copia file configurazione App PanelPC",
      "description": "Aggiorna il file di configurazione del Panel PC.",
      "script": "cp $(Backup:Root:Path)\\Staging\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config $(Install:Root:Path)\\$(Install:PPC:Path)\\Ferretto.VW.App.exe.config"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 11,
      "title": "Copia file configurazione MAS",
      "description": "Aggiorna il file di configurazione del MAS.",
      "script": "cp $(Backup:Root:Path)\\Staging\\$(Install:MAS:Path)\\appsettings.json $(Install:Root:Path)\\$(Install:MAS:Path)\\appsettings.json"
    },
    /**********************
    {
      "$type": "Ferretto.VW.Installer.Core.UpdateMASConfig, Ferretto.VW.Installer.Core",
      "number": 12,
      "title": "Aggiorna MAS",
      "description": "Aggiorna il file di configurazione del MAS."
    },
    */

    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 11,
      "title": "Avvia il MAS",
      "description": "Avvia il servizio di automazione aggiornato così che il database venga aggiornato.",
      //   "script": "Start-Service \"$(MAS:ServiceName)\"",
      //  "rollbackScript": "Stop-Service \"$(MAS:ServiceName)\"",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.MasHealthCheckStep, Ferretto.VW.Installer.Core",
      "number": 12,
      "title": "Verifica stato del MAS",
      "description": "Verifica che il servizio di automazione dichiari di essere operativo.",
      "url": "$(MAS:BaseUrl)/health/live",
      "timeout": "10000"
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 13,
      "title": "Cancella backup precedente",
      "description": "Elimina, se esiste, l'archivio contenente il backup della versione precedente a quella installata prima dell'aggiornamento.",
      "script": "Remove-Item $(Backup:Root:Path)\\Backup.zip -ErrorAction SilentlyContinue",
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 14,
      "title": "Rinomina backup corrente",
      "description": "Rinomina lo zip della versione corrente.",
      "script": "Rename-Item $(Backup:Root:Path)\\Current_Version_Backup.zip $(Backup:Root:Path)\\Backup.zip",
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 15,
      "title": "Cancella file temporanei",
      "description": "Elimina i file temporanei creati durante la fase di aggiornamento.",
      "script": "Remove-Item $(Backup:Root:Path)\\Staging -Recurse",
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 16,
      "title": "Riabilita UWF",
      "description": "Riabilita la protezione del disco fisso per sigillare il PanelPC.",
      "script": "uwfmgr filter enable",
      "rollbackScript": "uwfmgr filter disable",
      "skipRollback": true
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 16,
      "title": "Riavvia il sistema",
      "description": "Riavvia il sistema operativo per completare l'abilitazione della protezione.",
      // "script": "shutdown /r /t 0 /f /d p:4:2 /c \"Vertimag Software Setup\"",
      "script": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 17,
      "title": "Controlla stato UWF",
      "description": "Controlla che la protezione del disco fisso sia abilitata.",
      //"script": "uwfmgr filter disable",
      //"rollbackScript": "uwfmgr filter enable",
      "script": "timeout /T 2", // ** fake
      "rollbackScript": "timeout /T 2" // ** fake
    },
    {
      "$type": "Ferretto.VW.Installer.Core.PowershellStep, Ferretto.VW.Installer.Core",
      "number": 18,
      "title": "Auto Avvio PPC",
      "description": "Imposta l'applicazione del PanelPC in avvio automatico dopo il login.",
      "script": "Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(Install:Root:Path)\\$(Install:PPC:Path)\\$(Install:PPC:FilePath)\"",
      "rollbackScript": "\"Set-ItemProperty -Path $(PPC:Registry:Path) -Name $(PPC:Registry:Key) -Value \"$(EmbeddedInstallationFilePath)\""
    },
    {
      "$type": "Ferretto.VW.Installer.Core.CommandlineStep, Ferretto.VW.Installer.Core",
      "number": 19,
      "title": "Riavvia il sistema",
      "description": "Riavvia il sistema operativo per l'auto avvio del software PanelPC.",
      // "script": "shutdown /r /t 0 /f /d p:4:2 /c \"Vertimag Software Setup\"",
      "script": "timeout /T 2" // ** fake
    }
  ]
}
