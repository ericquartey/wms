<UserControl x:Class="Ferretto.VW.App.Scaffolding.Controls.PropertyEditor"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:controls="clr-namespace:Ferretto.VW.App.Scaffolding.Controls"
             xmlns:converters="clr-namespace:Ferretto.VW.App.Scaffolding.Converters"
             xmlns:filters="clr-namespace:Ferretto.VW.App.Scaffolding.Behaviors"
             xmlns:interactivity="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:selectors="clr-namespace:Ferretto.VW.App.Scaffolding.Selectors"
             xmlns:validation="clr-namespace:Ferretto.VW.App.Scaffolding.ValidationRules"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <converters:DisplayNameConverter x:Key="DisplayNameConverter" />
        <converters:MultiBooleanConverter x:Key="MultiBooleanConverter" />
        <converters:ScaffoldTypeConverter x:Key="ScaffoldTypeConverter" />
        <converters:IsReadOnlyConverter x:Key="IsReadOnlyConverter" />
        <converters:IsEnabledConverter x:Key="IsEnabledConverter" />
        <converters:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibilityConverter" />
        <converters:ValidationRuleConverter x:Key="ValidationRuleConverter" />
        <converters:DefaultValueConverter x:Key="DefaultValueConverter" />

        <selectors:PropertyInfoDataTemplateSelector x:Key="PropertyInfoDataTemplateSelector" />
    </UserControl.Resources>
    <Grid Background="#55000000" DataContext="{Binding Entity, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=UserControl}}">
        <Grid VerticalAlignment="Center" HorizontalAlignment="Center" Background="#fff">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <TextBlock Text="{Binding Converter={StaticResource DisplayNameConverter}}"></TextBlock>

            <StackPanel Orientation="Horizontal" Grid.Row="2">
                <Button Content="Save">
                    <Button.IsEnabled>
                        <MultiBinding Converter="{StaticResource MultiBooleanConverter}">
                            <Binding Path="IsValid" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=UserControl}" />
                            <Binding Path="IsDirty" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType=UserControl}" />
                        </MultiBinding>
                    </Button.IsEnabled>
                </Button>
                <Button Content="Cancel" />
            </StackPanel>

            <ContentControl Grid.Row="1" ContentTemplateSelector="{StaticResource PropertyInfoDataTemplateSelector}">
                <ContentControl.Resources>

                    <!-- IP address -->
                    <DataTemplate x:Key="IPAddressDataTemplate">
                        <DataTemplate.Resources>
                            <converters:TwoWayConverter x:Key="TwoWayConverter" />
                        </DataTemplate.Resources>
                        <controls:IPAddressBox IsEnabled="{Binding Path=.,Converter={StaticResource IsEnabledConverter}}">
                            <controls:IPAddressBox.IPAddress>
                                <MultiBinding Converter="{StaticResource TwoWayConverter}" Mode="TwoWay">
                                    <Binding Path="Property" />
                                    <Binding Path="Instance" />
                                </MultiBinding>
                            </controls:IPAddressBox.IPAddress>
                        </controls:IPAddressBox>
                    </DataTemplate>

                    <!-- string (default) -->
                    <DataTemplate x:Key="StringDataTemplate">
                        <DataTemplate.Resources>
                            <converters:TwoWayConverter x:Key="TwoWayConverter" />
                        </DataTemplate.Resources>

                        <TextBox Width="200" DataContext="{Binding}" IsEnabled="{Binding Path=.,Converter={StaticResource IsEnabledConverter}}" Name="txtBox">
                            <TextBox.Resources>
                                <validation:BindingProxy x:Key="valueBridge" Data="{Binding Path=Text, ElementName=txtBox}" />
                                <validation:BindingProxy x:Key="entityBridge" Data="{Binding Path=DataContext, ElementName=txtBox}" />
                            </TextBox.Resources>
                            <TextBox.Text>
                                <MultiBinding Converter="{StaticResource TwoWayConverter}" Mode="TwoWay">
                                    <Binding Path="Property" />
                                    <Binding Path="Instance" />
                                    <MultiBinding.ValidationRules>
                                        <validation:CompositeValidationRule ValidatesOnTargetUpdated="True">
                                            <validation:CompositeValidationRule.CompositeValidator>
                                                <validation:CompositeValidator Value="{Binding Data, Source={StaticResource valueBridge}}"
                                                                               Rules="{Binding Data, Source={StaticResource entityBridge}, Converter={StaticResource ValidationRuleConverter}}" />
                                            </validation:CompositeValidationRule.CompositeValidator>
                                        </validation:CompositeValidationRule>
                                    </MultiBinding.ValidationRules>
                                </MultiBinding>
                            </TextBox.Text>
                        </TextBox>
                    </DataTemplate>

                </ContentControl.Resources>
            </ContentControl>
            
        </Grid>
    </Grid>
</UserControl>
