resources:
- repo: self
  fetchDepth: 15
queue:
  name: Hosted VS2017
  demands: 
  - msbuild
  - visualstudio
  - vstest

trigger:
  batch: true
  branches:
    include:
    - develop
  paths:
    exclude:
    - VerticalWarehouses
    - WMS
    - Common
    include:
    - Common\DataModels
    - Common\EF

variables:
  CloudInitialCatalog: 'FerrettoWmsDb_Testing_$(Build.BuildId)'


steps:

- task: andrewlackenby.sql-toolkit.runsqlcommand.RunSqlCommand@2
  displayName: 'Create cloud db'
  inputs:
    serverName: 'rd-ferrettogroup.database.windows.net'
    databaseName: master
    sqlCommand: 'CREATE DATABASE $(CloudInitialCatalog);'
    userName: admin_rd_ferrettogroup
    userPassword: Ferretto2019!
    queryTimeout: 240


- template: azure-pipeline-deploy-db-template.yml


- task: andrewlackenby.sql-toolkit.runsqlcommand.RunSqlCommand@2
  displayName: 'Drop cloud db'
  inputs:
    serverName: 'rd-ferrettogroup.database.windows.net'
    databaseName: master
    sqlCommand: 'DROP DATABASE $(CloudInitialCatalog);'
    userName: admin_rd_ferrettogroup
    userPassword: Ferretto2019!
    queryTimeout: 120
    condition: always()
